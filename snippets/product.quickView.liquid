<style>
  .quick-view-images {
    flex: 1;
    max-width: 50%;
  }
  .quick-view-info {
    flex: 1;
  }
  .swiper-slide img {
    max-width: 100%;
    height: auto;
  }
</style>

<div class="quick-view-images">
  <div class="swiper quickview-swiper">
    <div class="swiper-wrapper">
      {% for image in product.images %}
        <div class="swiper-slide">
          <img src="{{ image | img_url: '600x600' }}" alt="{{ product.title }}" style="width:100%; border-radius: 10px;" />
        </div>
      {% endfor %}
    </div>
    <div class="swiper-button-next"></div>
    <div class="swiper-button-prev"></div>
    <div class="swiper-pagination"></div>
  </div>
</div>

<div class="quick-view-info">
  <h2>{{ product.title }}</h2>
  <p class="quick-view-price">{{ product.price | money }}</p>

  <form id="QuickViewCartForm">
    <input type="hidden" name="id" id="variant-id" value="{{ product.variants.first.id }}" />

    {% for option in product.options_with_values %}
      <label>{{ option.name }}</label>
      <select name="option-{{ option.position }}" class="variant-option">
        {% for value in option.values %}
          <option value="{{ value }}">{{ value }}</option>
        {% endfor %}
      </select>
    {% endfor %}

    <button type="submit" class="add-to-cart-btn">Add to Cart</button>
    <div class="add-to-cart-status" style="margin-top: 10px;"></div>
  </form>
</div>

<script>
  const swiper = new Swiper('.quickview-swiper', {
    navigation: { nextEl: '.swiper-button-next', prevEl: '.swiper-button-prev' },
    pagination: { el: '.swiper-pagination', clickable: true },
    loop: true,
  });

  const variants = {{ product.variants | json }};
  const selectEls = document.querySelectorAll('.variant-option');
  const variantIdInput = document.getElementById('variant-id');

  function updateVariant() {
    const selected = Array.from(selectEls).map(el => el.value);
    const match = variants.find(v => JSON.stringify(v.options) === JSON.stringify(selected));
    if (match) {
      variantIdInput.value = match.id;
      document.querySelector('.quick-view-price').textContent = Shopify.formatMoney(match.price, "{{ shop.money_format }}");
    }
  }

  selectEls.forEach(el => el.addEventListener('change', updateVariant));

  // AJAX Add to Cart
  document.getElementById('QuickViewCartForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = {
      items: [{
        id: variantIdInput.value,
        quantity: 1
      }]
    };

    fetch('/cart/add.js', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(formData)
    })
    .then(res => res.json())
    .then(data => {
      document.querySelector('.add-to-cart-status').innerHTML = `<span style="color:green;">Added to cart!</span>`;
    })
    .catch(err => {
      document.querySelector('.add-to-cart-status').innerHTML = `<span style="color:red;">Error adding to cart</span>`;
    });
  });
</script>
